# Календарь отпусков - Дизайн системы

**Дата:** 7 февраля 2026

## Обзор

Система для автоматического сбора дат отпусков из рабочего чата Пачка и отображения их в веб-календаре. Сотрудники пишут даты в произвольной форме, AI распознаёт их и добавляет в календарь.

## Стек технологий

| Компонент | Технология |
|-----------|------------|
| Фреймворк | Next.js 15 (App Router) |
| UI | shadcn/ui + Tailwind CSS |
| Календарь | React Big Calendar |
| AI-парсер | DeepSeek API |
| База данных | Supabase PostgreSQL |
| Хостинг | Vercel (бесплатный tier) |
| Webhook | Пачка Integration |

## Архитектура

### Три основных компонента

**1. Webhook-эндпоинт (Next.js API Route)**
- Принимает POST-запросы от Пачки при каждом сообщении
- Извлекает текст сообщения и информацию об авторе
- Передаёт в AI-парсер

**2. AI-парсер (Server Action)**
- Использует DeepSeek API
- Извлекает из произвольного текста:
  - Имя сотрудника
  - Дату начала отпуска
  - Дату конца отпуска
  - Год (если не указан - текущий)
- Возвращает структурированные данные или ошибку

**3. База данных (Supabase)**
- Таблица `vacations`
- API для чтения записей

### Поток данных

```
Сообщение в Пачке → Webhook → DeepSeek → Supabase → Календарь
```

## База данных

### Таблица `vacations`

```sql
CREATE TABLE vacations (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  employee_name TEXT NOT NULL,
  employee_id TEXT NOT NULL,  -- ID из Пачки для автозамены
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  message_text TEXT  -- исходный текст для отладки
);
```

## AI-парсинг

### DeepSeek API промпт

```
Ты - парсер отпусков. Извлеки из сообщения информацию об отпуске.

ПРАВИЛА:
- Извлеки имя сотрудника и даты начала/конца отпуска
- Если год не указан - используй текущий 2026
- Отвечай ТОЛЬКО валидным JSON
- Если в сообщении нет информации об отпуске - верни {"vacation": null}

ФОРМАТ ОТВЕТА (JSON):
{
  "employee_name": "имя",
  "start_date": "YYYY-MM-DD",
  "end_date": "YYYY-MM-DD"
}

Сообщение: {user_message}
```

## Фронтенд

### Главная страница (`/`)

**Две вкладки:**

1. **Вкладка "Календарь"**
   - Месячный вид с цветными блоками отпусков
   - Переключение месяцев (вперёд/назад)
   - Текущий месяц при загрузке

2. **Вкладка "Список"**
   - Таблица: Имя | Даты отпуска

**Технологии:**
- React Big Calendar
- shadcn/ui для компонентов
- Tailwind CSS для стилей
- date-fns для работы с датами

## Настройка интеграции с Пачкой

### В Пачке

1. **Создать бота:**
   - Автоматизации → Интеграции → Webhook → "+"
   - Название: "Календарь отпусков"
   - Загрузить аватарку

2. **Исходящий вебхук:**
   - URL: `https://your-project.vercel.app/api/webhook`
   - Выбрать: "Любые сообщения"

3. **Добавить бота в чат:**
   - Настройки чата → Добавить участников → Интеграции

## Переменные окружения

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key

# DeepSeek API
DEEPSEEK_API_KEY=sk-3387adaa83444b26a4bf3ef5920e62d1
```

## Функциональность MVP

### Включено:
- ✅ Webhook от Пачки
- ✅ AI-парсинг дат
- ✅ Автозамена отпусков (новое сообщение перезаписывает старое)
- ✅ Календарь (месячный вид)
- ✅ Список отпусков
- ✅ Переключение месяцев
- ✅ Адаптивный дизайн

### Не включено (будущие доработки):
- ❌ Фильтры по годам/месяцам
- ❌ Переключение видов (месяц/неделя/год)
- ❌ Мониторинг ошибок (Sentry)
- ❌ Автоответы в чат Пачки

## Обработка ошибок (базовая)

- **AI не понял дату:** игнорируем сообщение (status 200)
- **Некорректные даты:** игнорируем сообщение
- **Сообщение не про отпуск:** игнорируем сообщение
- **Supabase недоступен:** логируем ошибку
